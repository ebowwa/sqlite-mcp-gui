<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQLite MCP GUI</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #16213e;
      padding: 12px 20px;
      border-bottom: 1px solid #0f3460;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    h1 { font-size: 18px; font-weight: 600; }
    .connection-bar {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    input, button {
      background: #0f3460;
      border: 1px solid #00d9ff;
      color: #eee;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 13px;
    }
    input { width: 300px; }
    button:hover { background: #00d9ff; color: #1a1a2e; cursor: pointer; }
    .status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 3px;
    }
    .status.connected { background: #22c55e; }
    .status.disconnected { background: #ef4444; }
    main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #sidebar {
      width: 200px;
      background: #16213e;
      border-right: 1px solid #0f3460;
      overflow-y: auto;
    }
    #sidebar h3 {
      font-size: 12px;
      text-transform: uppercase;
      padding: 10px 15px;
      color: #666;
    }
    .table-item {
      padding: 8px 15px;
      cursor: pointer;
      font-size: 13px;
    }
    .table-item:hover { background: #0f3460; }
    .table-item.active { background: #00d9ff; color: #1a1a2e; }
    #content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #query-area {
      padding: 15px;
      border-bottom: 1px solid #0f3460;
    }
    #query-input {
      width: 100%;
      min-height: 100px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      resize: vertical;
      background: #0f3460;
      border: 1px solid #00d9ff;
      color: #eee;
      padding: 10px;
    }
    #query-actions {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    #results {
      flex: 1;
      overflow: auto;
      padding: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid #0f3460;
    }
    th {
      background: #16213e;
      position: sticky;
      top: 0;
      font-weight: 600;
    }
    tr:hover { background: #0f3460; }
    .error {
      color: #ef4444;
      padding: 20px;
    }
    .success {
      color: #22c55e;
      padding: 10px;
    }
    .empty {
      color: #666;
      text-align: center;
      padding: 40px;
    }
    .query-info {
      font-size: 12px;
      color: #666;
      padding: 5px 15px;
      background: #16213e;
    }
  </style>
</head>
<body>
  <header>
    <h1>SQLite MCP GUI</h1>
    <div class="connection-bar">
      <input type="text" id="dbPath" placeholder="/path/to/database.db" value="./data.db">
      <button onclick="connect()">Connect</button>
      <span id="status" class="status disconnected">Not Connected</span>
    </div>
  </header>

  <main>
    <div id="sidebar">
      <h3>Tables</h3>
      <div id="tables"></div>
    </div>

    <div id="content">
      <div id="query-area">
        <textarea id="query-input" placeholder="Enter SQL query...">SELECT * FROM sqlite_master LIMIT 10;</textarea>
        <div id="query-actions">
          <button onclick="executeQuery()">Run Query (Ctrl+Enter)</button>
          <button onclick="loadSchema()">Show Schema</button>
        </div>
      </div>
      <div id="results"></div>
    </div>
  </main>

  <script>
    let currentDb = null;
    let currentTable = null;

    async function connect() {
      const dbPath = document.getElementById('dbPath').value;
      if (!dbPath) return alert('Enter database path');

      try {
        const res = await fetch('/api/connect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dbPath })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        currentDb = dbPath;
        updateStatus(true);
        loadTables();
        showResults({ success: true, rows: 0, data: [] }, `Connected to ${dbPath}`);
      } catch (e) {
        alert('Connection failed: ' + e.message);
        updateStatus(false);
      }
    }

    function updateStatus(connected) {
      const el = document.getElementById('status');
      el.textContent = connected ? 'Connected' : 'Not Connected';
      el.className = 'status ' + (connected ? 'connected' : 'disconnected');
    }

    async function loadTables() {
      try {
        const res = await fetch('/api/tables');
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        const tablesEl = document.getElementById('tables');
        tablesEl.innerHTML = data.tables.map(t =>
          `<div class="table-item" onclick="selectTable('${t}')">${t}</div>`
        ).join('');
      } catch (e) {
        console.error(e);
      }
    }

    function selectTable(name) {
      currentTable = name;
      document.querySelectorAll('.table-item').forEach(el => el.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('query-input').value = `SELECT * FROM ${name} LIMIT 100;`;
    }

    async function loadSchema() {
      if (!currentTable) return alert('Select a table first');
      try {
        const res = await fetch(`/api/schema/${currentTable}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showResults({ success: true, data: data.columns }, `Schema: ${currentTable}`, true);
      } catch (e) {
        showResults({ error: e.message });
      }
    }

    async function executeQuery() {
      const sql = document.getElementById('query-input').value;
      if (!sql.trim()) return;
      if (!currentDb) return alert('Connect to database first');

      try {
        const res = await fetch('/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sql })
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        showResults(data);
      } catch (e) {
        showResults({ error: e.message });
      }
    }

    function showResults(data, info = '', isSchema = false) {
      const el = document.getElementById('results');
      if (data.error) {
        el.innerHTML = `<div class="error">${data.error}</div>`;
        return;
      }

      let html = '';
      if (info) html += `<div class="query-info">${info}</div>`;
      if (data.duration && !isSchema) html += `<div class="query-info">${data.rows} rows in ${data.duration}</div>`;
      if (data.changes !== undefined) html += `<div class="success">${data.changes} row(s) affected</div>`;

      if (!data.data || data.data.length === 0) {
        html += '<div class="empty">No results</div>';
      } else {
        const keys = Object.keys(data.data[0]);
        html += '<table><thead><tr>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr></thead><tbody>';
        html += data.data.map(row =>
          '<tr>' + keys.map(k => `<td>${row[k] ?? 'NULL'}</td>`).join('') + '</tr>'
        ).join('');
        html += '</tbody></table>';
      }
      el.innerHTML = html;
    }

    // Ctrl+Enter to run query
    document.getElementById('query-input').addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') executeQuery();
    });

    // Check health on load
    fetch('/health').then(r => r.json()).then(d => {
      if (d.connected) {
        currentDb = d.database;
        updateStatus(true);
        loadTables();
      }
    });
  </script>
</body>
</html>
